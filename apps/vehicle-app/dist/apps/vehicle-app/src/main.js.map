{
  "version": 3,
  "sources": ["../../../../src/main.ts"],
  "sourcesContent": ["import { faker } from '@faker-js/faker';\nimport * as grpc from '@grpc/grpc-js';\nimport * as protoLoader from '@grpc/proto-loader';\nimport { VehicleLocationTypes } from '@io/grpc-types';\nimport { join } from 'path';\nimport { workspaceRoot } from '@nx/devkit';\n\n// Load the vehicle location proto\nconst packageDef = protoLoader.loadSync(\n  join(workspaceRoot, 'libs/grpc-types/src/proto', 'vehicle-location.proto')\n);\n\nconst grpcObject = grpc.loadPackageDefinition(packageDef);\n\nconst vehicleLocationPackage = grpcObject.vehicle_location as grpc.GrpcObject;\nconst VehicleLocationClient =\n  vehicleLocationPackage.VehicleLocationService as grpc.ServiceClientConstructor;\n\n// Create gRPC client to connect to vehicle-location-service\nconst vehicleLocationClient = new VehicleLocationClient(\n  'localhost:50051',\n  grpc.credentials.createInsecure()\n);\n\ninterface Vehicle {\n  id: string;\n  routeId: string;\n  currentLocation: {\n    latitude: string;\n    longitude: string;\n  };\n}\n\nfunction sendVehicleLocation(vehicle: Vehicle): Promise<VehicleLocationTypes.VehicleLocationReply> {\n  return new Promise((resolve, reject) => {\n    const locationData: VehicleLocationTypes.VehicleLocation = {\n      vehicleId: vehicle.id,\n      routeId: vehicle.routeId,\n      latitude: vehicle.currentLocation.latitude,\n      longitude: vehicle.currentLocation.longitude,\n    };\n\n    const request: VehicleLocationTypes.VehicleLocationRequest = {\n      vehicleLocations: locationData,\n    };\n\n    vehicleLocationClient.SendVehicleLocation(\n      request,\n      (error: grpc.ServiceError | null, response: VehicleLocationTypes.VehicleLocationReply) => {\n        if (error) {\n          console.error(\n            `Error sending location for vehicle ${vehicle.id}:`,\n            error\n          );\n          reject(error);\n          return;\n        }\n\n        console.log(\n          `\u2705 Location sent for vehicle ${vehicle.id} on route ${vehicle.routeId}`\n        );\n        resolve(response);\n      }\n    );\n  });\n}\n\n// Startup message\nconsole.log('\uD83D\uDE97 Vehicle Location Client started');\nconsole.log('\uD83D\uDCE1 Connected to Vehicle Location Service at localhost:50051');\nconsole.log('\uD83D\uDD04 Auto-sending vehicle locations every 30 seconds...');\nconsole.log('\uD83D\uDCA1 To stop: Press Ctrl+C or send SIGTERM/SIGINT signal');\nconsole.log('\uD83D\uDCDD Process PID:', process.pid);\nconsole.log('---');\n\nconst appInterval = setInterval(async () => {\n  console.log('\\n\uD83D\uDE97 Auto-updating vehicle locations...');\n\n  try {\n    const vehicle = {\n      id: '1',\n      routeId: '1',\n      currentLocation: {\n        latitude: faker.location.latitude().toString(),\n        longitude: faker.location.longitude().toString(),\n      },\n    };\n\n    await sendVehicleLocation(vehicle);\n\n    console.log(\n      `\uD83D\uDCCD Sent vehicle location for vehicle ${vehicle.id} on route ${vehicle.routeId} at ${vehicle.currentLocation.latitude}, ${vehicle.currentLocation.longitude}`\n    );\n  } catch (error) {\n    console.error('Error in auto-update:', error);\n  }\n}, 3000);\n\n// Graceful shutdown function\nfunction gracefulShutdown(signal: string) {\n  console.log(`\\n\uD83D\uDED1 Received ${signal}, shutting down Vehicle App...`);\n\n  // 1. Clear the interval first\n  if (appInterval) {\n    clearInterval(appInterval);\n    console.log('\u2705 Interval cleared');\n  }\n\n  // 2. Close gRPC client connection gracefully\n  try {\n    vehicleLocationClient.close();\n    console.log('\u2705 gRPC client connection closed');\n  } catch (error) {\n    console.error('\u26A0\uFE0F Error closing gRPC client:', error);\n  }\n\n  console.log('\u2705 Vehicle App shutdown complete');\n  process.exit(0);\n}\n\n// Handle different termination signals\nprocess.on('SIGINT', () => gracefulShutdown('SIGINT')); // Ctrl+C\nprocess.on('SIGTERM', () => gracefulShutdown('SIGTERM')); // Docker/PM2 stop\nprocess.on('SIGUSR1', () => gracefulShutdown('SIGUSR1')); // Custom shutdown\nprocess.on('SIGUSR2', () => gracefulShutdown('SIGUSR2')); // Custom shutdown\n\n// Handle uncaught exceptions and unhandled rejections\nprocess.on('uncaughtException', (error) => {\n  console.error('\uD83D\uDCA5 Uncaught Exception:', error);\n  if (appInterval) clearInterval(appInterval);\n  vehicleLocationClient.close();\n  process.exit(1);\n});\n\nprocess.on('unhandledRejection', (reason, promise) => {\n  console.error('\uD83D\uDCA5 Unhandled Rejection at:', promise, 'reason:', reason);\n  if (appInterval) clearInterval(appInterval);\n  vehicleLocationClient.close();\n  process.exit(1);\n});\n\n// Optional: Add a manual shutdown endpoint (useful for testing)\nprocess.stdin.setEncoding('utf8');\nprocess.stdin.on('data', (data) => {\n  const input = data.toString().trim();\n  if (input === 'quit' || input === 'exit' || input === 'stop') {\n    console.log('\uD83D\uDCDD Manual shutdown requested via stdin');\n    gracefulShutdown('MANUAL');\n  }\n});\n"],
  "mappings": "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",
  "names": []
}
