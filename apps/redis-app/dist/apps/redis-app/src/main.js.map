{
  "version": 3,
  "sources": ["../../../../src/main.ts"],
  "sourcesContent": ["import { redisCluster, closeRedisCluster } from '@io/cache-util';\n\n(async function main() {\n  /**\n   * SET\n   */\n  await redisCluster.set(\n    'user:1001',\n    JSON.stringify({\n      id: 1001,\n      name: 'John Doe',\n      email: 'john@example.com',\n    })\n  );\n\n  /**\n   * GET\n   */\n  const user1001 = await redisCluster.get('user:1001');\n  console.log(user1001);\n\n  /**\n   * SETEX\n   */\n  await redisCluster.setex(\n    'session:abc123',\n    300,\n    JSON.stringify({\n      userId: 1001,\n      loginTime: new Date().toISOString(),\n    })\n  );\n\n  /**\n   * MGET\n   */\n  await redisCluster.set('{user:1001}:name', 'John Doe');\n  await redisCluster.set('{user:1001}:email', 'john@example.com');\n  await redisCluster.set('{user:1001}:age', '30');\n  const [name, email, age] = await redisCluster.mget(\n    '{user:1001}:name',\n    '{user:1001}:email',\n    '{user:1001}:age'\n  );\n  console.log('\u2705 Hash Tags + MGET:', { name, email, age });\n\n  /**\n   * Atomic set and get with NX flag\n   */\n  await redisCluster.set('product:1001', 'user:1001', 'EX', 300, 'NX');\n  const seat1001 = await redisCluster.get('seat:1001');\n  console.log('\u2705 Atomic set:', seat1001);\n\n  \n  /**\n   * INCR - Distributed Counter Pattern\n   * Using hash tags to keep shards on same node for efficient MGET\n   */\n  const SHARD_COUNT = 3;\n\n  // Simulate 3 workers incrementing the counter\n  for (let workerId = 0; workerId < 3000000; workerId++) {\n    const shardId = workerId % SHARD_COUNT;\n    // Hash tag {post:1001} ensures all shards on same node\n    await redisCluster.incr(`{post:1001}:views:${shardId}`);\n  }\n\n  // Read all shards efficiently with MGET (single network call)\n  const shardKeys = Array.from(\n    { length: SHARD_COUNT },\n    (_, i) => `{post:1001}:views:1${i}`\n  );\n  const shardValues = await redisCluster.mget(...shardKeys);\n  const totalViews = shardValues.reduce(\n    (sum, val) => sum + (Number(val) || 0),\n    0\n  );\n\n  console.log(`\u2705 INCR distributed counter: ${totalViews} total views`);\n  console.log(`   Shards: [${shardValues.join(', ')}]`);\n})();\n\n/**\n-------- shutdown --------\n */\nasync function gracefulShutdown(signal: string) {\n  await closeRedisCluster();\n  process.exit(0);\n}\n\nprocess.on('SIGINT', () => gracefulShutdown('SIGINT')); // Ctrl+C\nprocess.on('SIGTERM', () => gracefulShutdown('SIGTERM')); // Docker/PM2 stop\nprocess.on('SIGUSR1', () => gracefulShutdown('SIGUSR1')); // Custom shutdown\nprocess.on('SIGUSR2', () => gracefulShutdown('SIGUSR2')); // Custom shutdown\n\nprocess.on('uncaughtException', async (error) => {\n  await closeRedisCluster();\n  process.exit(1);\n});\n\nprocess.on('unhandledRejection', async (reason, promise) => {\n  await closeRedisCluster();\n  process.exit(1);\n});\n\nprocess.stdin.setEncoding('utf8');\nprocess.stdin.on('data', (data) => {\n  const input = data.toString().trim();\n  if (input === 'quit' || input === 'exit' || input === 'stop') {\n    gracefulShutdown('MANUAL');\n  }\n});\n"],
  "mappings": ";AAAA,wBAAgD;AAAA,CAE/C,eAAe,OAAO;AAIrB,QAAM,+BAAa;AAAA,IACjB;AAAA,IACA,KAAK,UAAU;AAAA,MACb,IAAI;AAAA,MACJ,MAAM;AAAA,MACN,OAAO;AAAA,IACT,CAAC;AAAA,EACH;AAKA,QAAM,WAAW,MAAM,+BAAa,IAAI,WAAW;AACnD,UAAQ,IAAI,QAAQ;AAKpB,QAAM,+BAAa;AAAA,IACjB;AAAA,IACA;AAAA,IACA,KAAK,UAAU;AAAA,MACb,QAAQ;AAAA,MACR,YAAW,oBAAI,KAAK,GAAE,YAAY;AAAA,IACpC,CAAC;AAAA,EACH;AAKA,QAAM,+BAAa,IAAI,oBAAoB,UAAU;AACrD,QAAM,+BAAa,IAAI,qBAAqB,kBAAkB;AAC9D,QAAM,+BAAa,IAAI,mBAAmB,IAAI;AAC9C,QAAM,CAAC,MAAM,OAAO,GAAG,IAAI,MAAM,+BAAa;AAAA,IAC5C;AAAA,IACA;AAAA,IACA;AAAA,EACF;AACA,UAAQ,IAAI,4BAAuB,EAAE,MAAM,OAAO,IAAI,CAAC;AAKvD,QAAM,+BAAa,IAAI,gBAAgB,aAAa,MAAM,KAAK,IAAI;AACnE,QAAM,WAAW,MAAM,+BAAa,IAAI,WAAW;AACnD,UAAQ,IAAI,sBAAiB,QAAQ;AAOrC,QAAM,cAAc;AAGpB,WAAS,WAAW,GAAG,WAAW,KAAS,YAAY;AACrD,UAAM,UAAU,WAAW;AAE3B,UAAM,+BAAa,KAAK,qBAAqB,OAAO,EAAE;AAAA,EACxD;AAGA,QAAM,YAAY,MAAM;AAAA,IACtB,EAAE,QAAQ,YAAY;AAAA,IACtB,CAAC,GAAG,MAAM,sBAAsB,CAAC;AAAA,EACnC;AACA,QAAM,cAAc,MAAM,+BAAa,KAAK,GAAG,SAAS;AACxD,QAAM,aAAa,YAAY;AAAA,IAC7B,CAAC,KAAK,QAAQ,OAAO,OAAO,GAAG,KAAK;AAAA,IACpC;AAAA,EACF;AAEA,UAAQ,IAAI,oCAA+B,UAAU,cAAc;AACnE,UAAQ,IAAI,eAAe,YAAY,KAAK,IAAI,CAAC,GAAG;AACtD,GAAG;AAKH,eAAe,iBAAiB,QAAgB;AAC9C,YAAM,qCAAkB;AACxB,UAAQ,KAAK,CAAC;AAChB;AAEA,QAAQ,GAAG,UAAU,MAAM,iBAAiB,QAAQ,CAAC;AACrD,QAAQ,GAAG,WAAW,MAAM,iBAAiB,SAAS,CAAC;AACvD,QAAQ,GAAG,WAAW,MAAM,iBAAiB,SAAS,CAAC;AACvD,QAAQ,GAAG,WAAW,MAAM,iBAAiB,SAAS,CAAC;AAEvD,QAAQ,GAAG,qBAAqB,OAAO,UAAU;AAC/C,YAAM,qCAAkB;AACxB,UAAQ,KAAK,CAAC;AAChB,CAAC;AAED,QAAQ,GAAG,sBAAsB,OAAO,QAAQ,YAAY;AAC1D,YAAM,qCAAkB;AACxB,UAAQ,KAAK,CAAC;AAChB,CAAC;AAED,QAAQ,MAAM,YAAY,MAAM;AAChC,QAAQ,MAAM,GAAG,QAAQ,CAAC,SAAS;AACjC,QAAM,QAAQ,KAAK,SAAS,EAAE,KAAK;AACnC,MAAI,UAAU,UAAU,UAAU,UAAU,UAAU,QAAQ;AAC5D,qBAAiB,QAAQ;AAAA,EAC3B;AACF,CAAC;",
  "names": []
}
